name: Mutation Testing (Nightly)

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *' # 8:00 PM EST

permissions:
  contents: write

jobs:
  # ------------------------------------------------------------------
  # JOB 1: BACKEND MUTATION
  # ------------------------------------------------------------------
  backend-mutation:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: Run Pitest
        working-directory: ./backend
        run: mvn test-compile org.pitest:pitest-maven:mutationCoverage

      - name: Upload Backend Artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-report
          # Uploads the folder containing index.html, style.css, etc.
          path: backend/target/pit-reports/ 
          if-no-files-found: error
          retention-days: 1

  # ------------------------------------------------------------------
  # JOB 2: FRONTEND MUTATION
  # ------------------------------------------------------------------
  frontend-mutation:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install Dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Run Stryker
        working-directory: ./frontend
        # Using your exact command
        run: npm run mutation

      - name: Upload Frontend Artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-report
          # targeting the single HTML file you specified
          path: frontend/reports/mutation/mutation.html 
          if-no-files-found: error
          retention-days: 1

  # ------------------------------------------------------------------
  # JOB 3: DEPLOY
  # ------------------------------------------------------------------
  deploy-mutation-reports:
    needs: [backend-mutation, frontend-mutation]
    runs-on: ubuntu-latest
    steps:
      # 1. Prepare Directories
      - name: Create Directories
        run: |
          mkdir -p public-temp/backend-mutation
          mkdir -p public-temp/frontend-mutation

      # 2. Handle Backend (Folder Structure)
      - name: Download Backend Report
        uses: actions/download-artifact@v4
        with:
          name: backend-report
          path: public-temp/backend-mutation
          # This will dump index.html, style.css, etc. into public-temp/backend-mutation/

      # 3. Handle Frontend (Single File Renaming)
      - name: Download Frontend Report
        uses: actions/download-artifact@v4
        with:
          name: frontend-report
          path: public-temp/frontend-mutation
      
      - name: Rename Frontend Report
        # We rename mutation.html -> index.html so the Dashboard link works
        run: |
          mv public-temp/frontend-mutation/mutation.html public-temp/frontend-mutation/index.html

      # 4. Push to gh-pages
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: ./public-temp
          keep_files: true  # Keeps existing Unit Test reports
          commit_message: "Update Mutation Reports [skip ci]"
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
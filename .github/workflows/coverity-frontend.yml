name: Coverity Scan - frontend

on:
  push:
    branches: [ master ]
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  coverity-scan:
    runs-on: ubuntu-latest

    # This defaults setting ONLY applies to "run" steps, not "uses" steps
    defaults:
      run:
        working-directory: frontend

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node 18
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          # Ensure this path is correct relative to root
          cache-dependency-path: frontend/package-lock.json

      - name: Install frontend dependencies
        # This inherits the working-directory: frontend
        run: |
          npm ci

      # Build + Coverity capture + upload
      - name: Run Coverity Scan action (build & upload)
        uses: vapier/coverity-scan-action@v1
        with:
          project: 'ShopEase - Frontend' 
          token: ${{ secrets.COVERITY_SCAN_FRONTEND_TOKEN }}
          email: ${{ secrets.COVERITY_SCAN_EMAIL }}
          build_language: 'javascript' 
          build_platform: 'linux64'
          # FIX: Explicitly change directory before building
          command: "cd frontend && npm run build"
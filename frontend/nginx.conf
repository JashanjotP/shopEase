server {
  # Listen on port 80 (which we'll map to 3000 on the host)
  listen 80;

  # --- Rule 1: Handle API requests ---
  # Any request starting with /api/ will be proxied
  location /api/ {
    # Forward the request to the 'app' service on port 8080
    # 'app' is the service name from docker-compose.yml
    proxy_pass http://app:8080/api/;
    
    # Set headers to pass along the original request info
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }

  # --- Rule 2: Handle all other requests (the React App) ---
  location / {
    # Serve files from this directory
    root /usr/share/nginx/html;
    # Serve index.html as the default
    index index.html;
    # This is the magic for React Router:
    # If a file isn't found, fall back to index.html
    try_files $uri $uri/ /index.html;
  }
}